'use strict';var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor);}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor;};}();function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function");}}var DEFAULT_CONFIG={'elementId':'functree','width':1800,'height':1800,'viewBoxWidth':1200,'viewBoxHeight':1200,'diameter':800,'duration':1000,'normalize':true,'displayRounds':true,'displayBars':false,'displayNodesLowerThan':5,'color':{'class':['#5f5f5f','#2F57D0','#5381DF','#41B360','#E0462F','#DA9F33']}};var FuncTree=function(){function FuncTree(root){var config=arguments.length>1&&arguments[1]!==undefined?arguments[1]:{};_classCallCheck(this,FuncTree);this.root=root;this.root.x0=0;this.root.y0=0;this.nodes=this.getNodes();this.config=Object.assign(DEFAULT_CONFIG,config);this.tree=d3.layout.tree().size([360,this.config.diameter/2]);var id=0;var _iteratorNormalCompletion=true;var _didIteratorError=false;var _iteratorError=undefined;try{for(var _iterator=this.nodes[Symbol.iterator](),_step;!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=true){var node=_step.value;node.id=id++;}}catch(err){_didIteratorError=true;_iteratorError=err;}finally{try{if(!_iteratorNormalCompletion&&_iterator.return){_iterator.return();}}finally{if(_didIteratorError){throw _iteratorError;}}}this.initTree();}_createClass(FuncTree,[{key:'configure',value:function configure(){var config=arguments.length>0&&arguments[0]!==undefined?arguments[0]:DEFAULT_CONFIG;this.config=Object.assign(this.config,config);return this;}},{key:'initTree',value:function initTree(){var _iteratorNormalCompletion2=true;var _didIteratorError2=false;var _iteratorError2=undefined;try{for(var _iterator2=this.nodes[Symbol.iterator](),_step2;!(_iteratorNormalCompletion2=(_step2=_iterator2.next()).done);_iteratorNormalCompletion2=true){var node=_step2.value;node.values=[];node.value=0;node.cols=[];if(node.children&&node.depth>=this.config.displayNodesLowerThan-1){node._children=node.children;node.children=null;}if(node._children&&node.depth<this.config.displayNodesLowerThan-1){node.children=node._children;node._children=null;}}}catch(err){_didIteratorError2=true;_iteratorError2=err;}finally{try{if(!_iteratorNormalCompletion2&&_iterator2.return){_iterator2.return();}}finally{if(_didIteratorError2){throw _iteratorError2;}}}return this;}},{key:'create',value:function create(){var elementId=arguments.length>0&&arguments[0]!==undefined?arguments[0]:this.config.elementId;var width=arguments.length>1&&arguments[1]!==undefined?arguments[1]:this.config.width;var height=arguments.length>2&&arguments[2]!==undefined?arguments[2]:this.config.height;var svg=d3.select('#'+elementId).insert('svg',':first-child').attr('xmlns','http://www.w3.org/2000/svg').attr('version','1.1').attr('width',width).attr('height',height).attr('viewBox','0 0 '+this.config.viewBoxWidth+' '+this.config.viewBoxHeight);var buffer=svg.append('g').attr('id','buffer').attr('transform','translate('+this.config.viewBoxWidth/2+','+this.config.viewBoxHeight/2+'),scale(1)');var groupIds=['rings','links','charts','rounds','labels','nodes'];var _iteratorNormalCompletion3=true;var _didIteratorError3=false;var _iteratorError3=undefined;try{for(var _iterator3=groupIds[Symbol.iterator](),_step3;!(_iteratorNormalCompletion3=(_step3=_iterator3.next()).done);_iteratorNormalCompletion3=true){var i=_step3.value;buffer.append('g').attr('id',i);}}catch(err){_didIteratorError3=true;_iteratorError3=err;}finally{try{if(!_iteratorNormalCompletion3&&_iterator3.return){_iterator3.return();}}finally{if(_didIteratorError3){throw _iteratorError3;}}}svg.call(d3.behavior.zoom().translate([this.config.viewBoxWidth/2,this.config.viewBoxHeight/2]).scaleExtent([0.5,10]).on('zoom',function(){buffer.attr({'transform':'translate('+d3.event.translate+'),scale('+d3.event.scale+')'});}));return this;}},{key:'update',value:function update(){var source=arguments.length>0&&arguments[0]!==undefined?arguments[0]:this.root;var nodes=this.tree.nodes(this.root);var links=this.tree.links(nodes);var depth=d3.max(nodes.map(function(x){return x.depth;}));var getClassMax=function getClassMax(nodes,maxFunc){return Array.from(new Array(depth+1)).map(function(v,i){var candidates=nodes.filter(function(x){return x.depth===i;}).map(maxFunc);return d3.max(candidates);});};var maxValue=getClassMax(nodes,function(x){return x.value;});var maxSumOfValues=getClassMax(nodes,function(x){return d3.sum(x.values);});var maxMaxOfValues=getClassMax(nodes,function(x){return d3.max(x.values);});this._updateRings(depth);this._updateLinks(links,source);this._updateNodes(nodes,source);this._updateBars(nodes,source,depth,maxSumOfValues,maxMaxOfValues);this._updateRounds(nodes,source,depth,maxValue);this._updateLabels(nodes,source,maxValue,maxSumOfValues);var _iteratorNormalCompletion4=true;var _didIteratorError4=false;var _iteratorError4=undefined;try{for(var _iterator4=nodes[Symbol.iterator](),_step4;!(_iteratorNormalCompletion4=(_step4=_iterator4.next()).done);_iteratorNormalCompletion4=true){var node=_step4.value;node.x0=node.x;node.y0=node.y;}// Enable showing tooltip by Bootstrap
}catch(err){_didIteratorError4=true;_iteratorError4=err;}finally{try{if(!_iteratorNormalCompletion4&&_iterator4.return){_iterator4.return();}}finally{if(_didIteratorError4){throw _iteratorError4;}}}$('[data-toggle="tooltip"]').tooltip({container:'body',placement:'top'});}},{key:'_updateRings',value:function _updateRings(depth){var _this=this;var ring=d3.select('#rings').selectAll('circle').data(d3.range(1,depth,2));ring.enter().append('circle').attr('fill','none').attr('r',function(d){return _this.config.diameter/2/depth*(d+0.5)||0;}).attr('stroke','#f8f8f8').attr('stroke-width',0);ring.transition().duration(this.config.duration).attr('r',function(d){return _this.config.diameter/2/depth*(d+0.5)||0;}).attr('stroke-width',this.config.diameter/2/depth||0);ring.exit().transition().duration(this.config.duration).attr('stroke-width',0).remove();}},{key:'_updateLinks',value:function _updateLinks(links,source){var _this2=this;var diagonal=d3.svg.diagonal.radial().projection(function(d){return[d.y,d.x/180*Math.PI];});var straight=function straight(d){var x=function x(d){return d.y*Math.cos((d.x-90)/180*Math.PI);};var y=function y(d){return d.y*Math.sin((d.x-90)/180*Math.PI);};return'M'+x(d.source)+','+y(d.source)+'L'+x(d.target)+','+y(d.target);};var link=d3.select('#links').selectAll('path').data(links,function(d){return d.target.id;});link.enter().append('path').attr('fill','none').attr('stroke','#999').attr('stroke-width',0.5).attr('stroke-dasharray',function(d){if(d.source.depth===0){return'3,3';}}).attr('d',function(d){var o={'x':source.x0,'y':source.y0};var vector={'source':o,'target':o};if(d.source.depth===0){return straight(vector);}else{return diagonal(vector);}}).on('mouseover',function(d){_this2._highlightLinks(d.target);}).on('mouseout',function(){d3.select('#links').selectAll('path').attr('style',null);});link.transition().duration(this.config.duration).attr('d',function(d){if(d.source.depth===0){return straight(d);}else{return diagonal(d);}});link.exit().transition().duration(this.config.duration).attr('d',function(d){var o={'x':source.x,'y':source.y};var vector={'source':o,'target':o};if(d.source.depth===0){return straight(vector);}else{return diagonal(vector);}}).remove();}},{key:'_updateNodes',value:function _updateNodes(nodes,source){var _this3=this;var node=d3.select('#nodes').selectAll('circle').data(nodes,function(d){return d.id;});node.enter().append('circle').attr('transform',function(){return'rotate('+(source.x0-90)+'),translate('+source.y0+')';}).attr('r',1).attr('fill',function(d){return d._children?'#ddd':'#fff';}).attr('stroke','#999').attr('stroke-width',0.5).attr('cursor','pointer').attr('data-toggle','tooltip').attr('data-original-title',function(d){return'['+d.entry+'] '+d.name;}).on('click',function(d){_this3._collapseChildren(d);_this3.update(d);}).on('mouseover',function(d){d3.select(d3.event.target).style('r',10).style('fill','#000').style('opacity',0.5);_this3._highlightLinks(d);}).on('mouseout',function(){d3.select(d3.event.target).attr('style',null);d3.select('#links').selectAll('path').attr('style',null);});node.transition().duration(this.config.duration).attr('fill',function(d){return d._children?'#ddd':'#fff';}).attr('transform',function(d){return'rotate('+(d.x-90)+'),translate('+d.y+')';});node.exit().transition().duration(this.config.duration).attr('r',0).attr('transform',function(){return'rotate('+(source.x-90)+'),translate('+source.y+')';}).remove();}},{key:'_updateBars',value:function _updateBars(nodes,source,depth,maxSumOfValues,maxMaxOfValues){var _this4=this;var config=this.config;var chart=d3.select('#charts').selectAll('g').data(nodes,function(d){return d.id;});chart.enter().append('g').attr('transform','rotate('+(source.x0-90)+'),translate('+source.y0+'),rotate(-90)').attr('data-toggle','tooltip').attr('data-original-title',function(d){return'['+d.entry+'] '+d.name;}).on('click',function(d){_this4._collapseChildren(d);_this4.update(d);}).on('mouseover',function(d){_this4._highlightLinks(d);}).on('mouseout',function(){d3.select('#links').selectAll('path').attr('style',null);});chart.transition().duration(this.config.duration).attr('transform',function(d){return'rotate('+(d.x-90)+'),translate('+d.y+'),rotate(-90)';});chart.exit().transition().duration(this.config.duration).attr('transform','rotate('+(source.x-90)+'),translate('+source.y+'),rotate(-90)').remove();var bar=chart.selectAll('rect').data(function(d){return d.values;});bar.enter().append('rect').attr('x',-1).attr('y',0).attr('width',2).attr('height',0).attr('fill',function(d,i){var n=i%config.color.class.length;return config.color.class[n];}).on('mouseover',function(d){d3.select(d3.event.target).style('fill','#000').style('opacity',0.5);_this4._highlightLinks(d);}).on('mouseout',function(){d3.select(d3.event.target).attr('style',null);d3.select('#charts').selectAll('rect').attr('style',null);});bar.transition().duration(this.config.duration).attr('y',function(d,i){var p=this.parentNode.__data__;var maxHight=config.diameter/2/depth*0.8;var subSum=d3.sum(p.values.slice(0,i));if(config.normalize){return subSum/maxSumOfValues[p.depth]*maxHight||0;}else{return subSum;}}).attr('height',function(d){var p=this.parentNode.__data__;var maxHight=config.diameter/2/depth*0.8;if(config.normalize){return d/maxSumOfValues[p.depth]*maxHight||0;}else{return d;}});bar.exit().transition().duration(this.config.duration).attr('y',0).attr('height',0).remove();}},{key:'_updateRounds',value:function _updateRounds(nodes,source,depth,max){var _this5=this;var circle=d3.select('#rounds').selectAll('circle').data(nodes,function(d){return d.id;});circle.enter().append('circle').attr('transform',function(){return'rotate('+(source.x0-90)+'),translate('+source.y0+')';}).attr('r',0).attr('fill',function(d){if(_this5.config.displayBars){return'#fff';}else{var n=d.depth%_this5.config.color.class.length;return _this5.config.color.class[n];}}).attr('stroke',function(){return _this5.config.displayBars?'#333':'#fff';}).attr('stroke-width',0.5).attr('opacity',0.75).attr('data-toggle','tooltip').attr('data-original-title',function(d){return'['+d.entry+'] '+d.name;}).on('click',function(d){_this5._collapseChildren(d);_this5.update(d);}).on('mouseover',function(d){d3.select(d3.event.target).style('fill','#000').style('opacity',0.5);_this5._highlightLinks(d);}).on('mouseout',function(){d3.select(d3.event.target).attr('style',null);d3.select('#links').selectAll('path').attr('style',null);});circle.transition().duration(this.config.duration).attr('r',function(d){var r_=25;if(_this5.config.normalize){return d.value/max[d.depth]*r_||0;}else{return d.value;}}).attr('transform',function(d){return'rotate('+(d.x-90)+'),translate('+d.y+')';});circle.exit().transition().duration(this.config.duration).attr('r',0).attr('transform',function(){return'rotate('+(source.x-90)+'),translate('+source.y+')';}).remove();}},{key:'_updateLabels',value:function _updateLabels(nodes,source,maxValue,maxSumOfValues){var _this6=this;var data=nodes.filter(function(d){return d.depth<2;});var label=d3.select('#labels').selectAll('g').data(data,function(d){return d.id;});label.enter().append('g').attr('transform',function(d){return'rotate('+(d.x-90)+'),translate('+d.y+'),rotate('+(90-d.x)+')';}).append('text').attr('text-anchor','middle').attr('font-family','arial, sans-serif').attr('font-size',function(d){var value=_this6.config.displayRounds?d.value:d3.sum(d.values);var max=_this6.config.displayRounds?maxValue[d.depth]:maxSumOfValues[d.depth];var size=(value/max*10||0)+10;return size;}).attr('y',function(d){var value=_this6.config.displayRounds?d.value:d3.sum(d.values);var max=_this6.config.displayRounds?maxValue[d.depth]:maxSumOfValues[d.depth];var size=(value/max*10+5||0)+10;return-size/2;}).attr('fill','#555').text(function(d){return d.name.replace(/ \[.*\]/,'').split(', ')[0];});label.transition().duration(this.config.duration).attr('transform',function(d){return'rotate('+(d.x-90)+'),translate('+d.y+'),rotate('+(90-d.x)+')';});label.exit().transition().duration(this.config.duration).remove();label.selectAll('text').call(d3.behavior.drag().on('dragstart',function(){d3.event.sourceEvent.stopPropagation();}).on('drag',function(d){d3.select(this).attr('y',0).attr('transform','translate('+d3.event.x+','+d3.event.y+')');}));}},{key:'getNodes',value:function getNodes(){var node=arguments.length>0&&arguments[0]!==undefined?arguments[0]:this.root;var nodes=arguments.length>1&&arguments[1]!==undefined?arguments[1]:[];var depth=arguments.length>2&&arguments[2]!==undefined?arguments[2]:0;node.depth=depth;nodes.push(node);var _iteratorNormalCompletion5=true;var _didIteratorError5=false;var _iteratorError5=undefined;try{for(var _iterator5=(node.children||node._children||[])[Symbol.iterator](),_step5;!(_iteratorNormalCompletion5=(_step5=_iterator5.next()).done);_iteratorNormalCompletion5=true){var _node=_step5.value;this.getNodes(_node,nodes,depth+1);}}catch(err){_didIteratorError5=true;_iteratorError5=err;}finally{try{if(!_iteratorNormalCompletion5&&_iterator5.return){_iterator5.return();}}finally{if(_didIteratorError5){throw _iteratorError5;}}}return nodes;}},{key:'_collapseChildren',value:function _collapseChildren(node){if(node.children){node._children=node.children;node.children=null;}else if(node._children){node.children=node._children;node._children=null;}}},{key:'_highlightLinks',value:function _highlightLinks(node){var _this7=this;d3.selectAll('path').filter(function(d){if(d.target.id===node.id){return true;}}).style('stroke',function(d){var n=d.target.depth%_this7.config.color.class.length;return _this7.config.color.class[n];}).style('stroke-width',1.5);if(node.parent){this._highlightLinks(node.parent);}}}]);return FuncTree;}();
//# sourceMappingURL=functree.js.map