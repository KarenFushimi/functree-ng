{% extends 'viewer.html' %}

{% block head %}
{{super()}}
<link rel="stylesheet" href="{{ url_for('static', filename='bower_components/jquery-ui/themes/base/jquery-ui.min.css') }}">
{% endblock %}

{% block sidebar %}
{# Disable Jinja's syntax for Vue.js #}
{% raw %}
<h5><i class="fa fa-search" aria-hidden="true"></i> Search <a href="#form-search" data-toggle="collapse">#</a></h5>
<form id="form-search" class="collapse in" v-on:submit.prevent="submit">
    <div class="form-group">
        <div class="input-group">
            <input type="text" class="form-control input-sm" placeholder="Search" v-model.lazy.trim="searchWord">
            <span class="input-group-btn">
                <button class="btn btn-primary btn-sm" type="submit">
                    <i class='fa fa-search fa-fw'></i>
                </button>
            </span>
        </div>
    </div>
</form>
<hr>
<h5><i class="fa fa-cog" aria-hidden="true"></i> Options <a href="#form-options" data-toggle="collapse">#</a></h5>
<form id="form-options" class="collapse in" v-on:submit.prevent="submit" v-on:reset="reset">
    <div class="form-group">
        <label class="control-label">Data series</label>
        <select class="form-control input-sm" v-on:change="clickOptionSeries" v-model="series">
            <option disabled value="">- Select data series -</option>
            <option v-for="(option, index) in options[0]" v-bind:value="index">{{option}}</option>
        </select>
    </div>
    <div class="form-group">
        <label class="control-label">Data mapping: Single</label>
        <select class="form-control input-sm" v-model="columnsSingle">
            <option value="">- Select a column -</option>
            <option v-for="(option, index) in options[1]" v-bind:value="index">{{option}}</option>
        </select>
    </div>
    <div class="form-group">
        <label class="control-label">Data mapping: Multiple</label>
        <select class="form-control input-sm" multiple v-model="columnsMultiple">
            <option value="">- Select columns -</option>
            <option v-for="(option, index) in options[1]" v-bind:value="index">{{option}}</option>
        </select>
    </div>
    <div class="form-group">
        <div class="checkbox">
            <label>
                <input type="checkbox" checked="checked" v-model="normalize">
                Enable normalization
            </label>
        </div>
    </div>
    <div class="form-group text-center">
        <button type="submit" class="btn btn-primary btn-sm"><i class="fa fa-refresh" aria-hidden="true"></i> Update</button>
        <button type="reset" class="btn btn-default btn-sm"> Reset</button>
    </div>
</form>
{% endraw %}
<hr>
<h5><i class="fa fa-info-circle" aria-hidden="true"></i> Information <a href="#form-information" data-toggle="collapse">#</a></h5>
<form id="form-information" class="collapse in">
    <div class="form-group">
        <div class="input-group">
            <input type="text" class="form-control input-sm" placeholder="No function selected" readonly style="background: #fff;" >
            <div class="input-group-addon" role="button" onclick="$('#form-information input')[0].select(); document.execCommand('copy');"><i class="fa fa-clipboard" aria-hidden="true"></i></div>
        </div>
    </div>
    <div class="form-group text-center">
        <button type="button" class="btn btn-primary btn-sm" data-toggle="modal" data-target="#modal-information">View detail <i class="fa fa-angle-double-right" aria-hidden="true"></i></button>
    </div>
</form>
<div id="modal-information" class="modal fade" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title">Information</h4>
            </div>
            <div class="modal-body">
                <pre></pre>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
<hr>
<h5><i class="fa fa-floppy-o" aria-hidden="true"></i> Save image <a href="#form-save-image" data-toggle="collapse">#</a></h5>
<form id="form-save-image" class="collapse in">
    <input type="hidden" name="csrf_token" value="{{csrf_token()}}">
    <div class="form-group">
        <label class="control-label">Format</label>
        <select name="format" class="form-control">
            <option value="pdf">PDF</option>
            <option value="png">PNG</option>
            <option value="ps">PostScript</option>
            <option value="svg">SVG</option>
            <option value="raw-svg">SVG (Raw)</option>
        </select>
    </div>
    <div class="form-group text-center">
        <button type="submit" class="btn btn-primary btn-sm"><i class="fa fa-floppy-o" aria-hidden="true"></i> Save</button>
    </div>
</form>
{% endblock %}

{% block mainpane %}
<div id="functree">
</div>
{% endblock %}

{% block script %}
{{super()}}
<script src="{{ url_for('static', filename='bower_components/d3/d3.min.js') }}"></script>
<script src="{{ url_for('static', filename='bower_components/vue/dist/vue.min.js') }}"></script>
<script src="{{ url_for('static', filename='dist/js/functree.js') }}"></script>
<script>
    d3.json('{{ url_for('route_tree', source=profile.target) }}', function(error, tree_data) {
    d3.json('{{ url_for('route_profile', profile_id=profile.profile_id) }}', function(error, profile_data) {
        var profile = profile_data[0];
        var funcTree = new FuncTree(tree_data[0]['tree']);
        funcTree
            .create()
            .update();

        new Vue({
            'el': '#form-search',
            'data': {
                'searchWord': ''
            },
            'methods': {
                'submit': function() {
                    funcTree.search(this.searchWord);
                }
            }
        });

        new Vue({
            'el': '#form-options',
            'data': {
                'series': '',
                'columnsSingle': '',
                'columnsMultiple': '',
                'normalize': true,
                'options': [
                    profile.series,
                    []
                ]
            },
            'methods': {
                'clickOptionSeries': function() {
                    this.$set(this.options, 1, profile.columns[this.series]);
                },
                'submit': function() {
                    var self = this;
                    var profile_dict = {};
                    for (var i = 0; i < profile.profile.length; i++) {
                        var node = profile.profile[i];
                        var p = {
                            'value': node.values[self.series][self.columnsSingle],
                            'values': node.values[self.series]
                                .filter(function(value, index) {
                                    return self.columnsMultiple.includes(index);
                                })
                        }
                        profile_dict[node.entry] = p;
                    }
                    for (var i = 0; i < funcTree.nodes.length; i++) {
                        var node = funcTree.nodes[i];
                        if (profile_dict[node.entry]) {
                            node.value = profile_dict[node.entry].value;
                            node.values = profile_dict[node.entry].values;
                        }
                    }
                    funcTree
                        .configure({
                            'normalize': self.normalize
                        })
                        .update();
                },
                'reset': function() {
                    funcTree
                        .initTree()
                        .update();
                }
            }
        });

        $('#form-search input').autocomplete({
            'minLength': 2,
            'source': funcTree.getNodes()
                .map(function(x) {
                    return x.entry;
                })
                .filter(function(x) {
                    return !x.startsWith('*') && !x.match(/K\d{5}/);
                })
                .sort(function(a, b) {
                    a = a.toString().toLowerCase();
                    b = b.toString().toLowerCase();
                    if (a > b) return 1;
                    if (a < b) return -1;
                    return 0;
                })
        });

        $('#loading').remove();
    })});

    $('#form-save-image').on('submit', function(event) {
        event.preventDefault();
        $('<form/>', {'action': '{{ url_for('route_save_image') }}', 'method': 'POST', 'target': '_blank'})
            .hide()
            .append($('<input/>', {'type': 'hidden', 'name': 'csrf_token', 'value': $(this).find('[name=csrf_token]').val()}))
            .append($('<input/>', {'type': 'hidden', 'name': 'format', 'value': $(this).find('[name=format]').val()}))
            .append($('<input/>', {'type': 'hidden', 'name': 'svg', 'value': (new XMLSerializer).serializeToString($('#functree > svg')[0])}))
            .appendTo(document.body)
            .submit()
            .remove();
    });

    $('#modal-information').on('show.bs.modal', function(event) {
        var target = $(this).find('.modal-body > pre');
        var entry = $('#form-information input').val();
        $.ajax({
            'url': '{{ url_for('route_get_entry') }}' + entry,
            'type': 'get',
            'dataType': 'text'
        }).done(function(data) {
            target.text(data);
        }).fail(function(jqXHR, textStatus, errorThrown) {
            if (jqXHR.status === 404) {
                target.text('No information available: ' + entry);
            } else {
                target.text('Ajax error');
            }
        });
    });
</script>
{% endblock %}
